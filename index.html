<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Voice Pitch Challenge: Do Re Mi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap");

      body {
        font-family: "Fredoka", sans-serif;
        touch-action: none;
        overflow: hidden;
        background-color: #111827;
        height: 100dvh;
        width: 100vw;
      }

      #gameCanvas {
        width: 100%;
        height: 100%;
        display: block;
        cursor: pointer;
      }

      .overlay {
        background: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(8px);
      }

      .glass-panel {
        background: rgba(31, 41, 55, 0.95);
        border: 1px solid rgba(75, 85, 99, 0.5);
        backdrop-filter: blur(12px);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }

      /* Custom Sliders */
      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 18px;
        width: 18px;
        border-radius: 50%;
        background: #60a5fa;
        margin-top: -7px;
        box-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
        cursor: pointer;
        border: 2px solid #1e3a8a;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: #374151;
        border-radius: 2px;
      }

      .tuning-pulse {
        animation: pulse-yellow 1.5s infinite;
      }
      @keyframes pulse-yellow {
        0% {
          box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(234, 179, 8, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
        }
      }
    </style>
  </head>
  <body class="flex flex-col text-white">
    <!-- Top UI Bar -->
    <div
      class="h-16 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 z-20 shrink-0 gap-2 shadow-lg"
    >
      <!-- Left: Tune & Practice -->
      <div class="flex items-center gap-2">
        <button
          id="tuneBtn"
          class="flex flex-col items-center justify-center bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded px-3 py-1 transition group min-w-[60px]"
        >
          <span
            class="text-[10px] text-gray-400 font-bold uppercase tracking-wider group-hover:text-white"
            >Range</span
          >
          <span id="tuneStatus" class="text-xs font-mono text-white"
            >C3-C4</span
          >
        </button>
        <button
          id="practiceBtn"
          class="flex flex-col items-center justify-center bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded px-3 py-1 transition group min-w-[60px]"
        >
          <span
            class="text-[10px] text-gray-400 font-bold uppercase tracking-wider group-hover:text-blue-400"
            >Mode</span
          >
          <span id="practiceStatus" class="text-xs font-mono text-gray-300"
            >Game</span
          >
        </button>
      </div>

      <!-- Center: Note Display -->
      <div class="flex flex-col items-center justify-center">
        <div
          class="flex items-baseline space-x-2 bg-gray-800/50 px-4 py-1 rounded-lg border border-gray-700"
        >
          <span
            id="noteDisplay"
            class="text-3xl font-bold text-blue-400 w-12 text-center"
            >-</span
          >
          <span class="text-gray-600 text-xl">|</span>
          <span id="scoreDisplay" class="text-3xl font-bold text-yellow-400"
            >0</span
          >
        </div>
      </div>

      <!-- Right: Settings & Mic -->
      <div class="flex items-center gap-4">
        <button
          id="settingsBtn"
          class="p-2 text-gray-400 hover:text-white transition bg-gray-800 rounded-full hover:bg-gray-700"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        </button>

        <div class="flex flex-col w-12 items-end">
          <label
            class="text-[9px] text-gray-400 font-bold uppercase tracking-wider mb-1"
            >Input</label
          >
          <div
            class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden relative bg-gray-700 border border-gray-600"
          >
            <div
              id="thresholdMarker"
              class="absolute top-0 bottom-0 w-0.5 bg-yellow-400 z-10 opacity-70"
              style="left: 10%"
            ></div>
            <div
              id="micVolumeBar"
              class="h-full bg-green-500 transition-all duration-75 w-0 shadow-[0_0_10px_rgba(34,197,94,0.5)]"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nerd Stats -->
    <div
      id="nerdStats"
      class="absolute top-20 right-4 p-3 rounded-lg border border-gray-700 bg-black/90 font-mono text-[10px] text-green-400 z-40 w-48 shadow-xl hidden"
    >
      <div class="flex justify-between border-b border-gray-700 pb-1 mb-1">
        <span class="text-white font-bold">DEBUG STATS</span>
      </div>
      <div class="flex justify-between">
        <span>Status:</span>
        <span id="debugStatus" class="text-white">Init</span>
      </div>
      <div class="flex justify-between">
        <span>RMS (Vol):</span>
        <span id="debugRMS" class="text-white">0.00</span>
      </div>
      <div class="flex justify-between">
        <span>Clarity:</span>
        <span id="debugConf" class="text-white">0.00</span>
      </div>
      <div class="flex justify-between">
        <span>Input Hz:</span> <span id="debugHz" class="text-white">0</span>
      </div>
      <div class="flex justify-between">
        <span>MIDI Note:</span> <span id="debugMidi" class="text-white">-</span>
      </div>
      <div class="mt-2 text-[9px] text-gray-500 pt-1 border-t border-gray-700">
        System: A440 Standard<br />Fixed Do (Do=C)
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="absolute inset-0 z-50 bg-black/60 hidden flex items-center justify-center backdrop-blur-sm transition-opacity"
    >
      <div class="glass-panel p-6 rounded-2xl w-80 border-t border-gray-600">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-white tracking-tight">Settings</h2>
          <button
            id="closeSettings"
            class="text-gray-400 hover:text-white text-2xl leading-none"
          >
            &times;
          </button>
        </div>

        <div class="mb-5 group">
          <div class="flex justify-between mb-2">
            <label
              class="text-xs text-gray-300 font-bold uppercase tracking-wide"
              >Mic Sensitivity</label
            >
            <span
              class="text-xs font-mono text-blue-400 bg-blue-900/30 px-1.5 rounded"
              id="sensVal"
              >10</span
            >
          </div>
          <input
            type="range"
            id="sensSlider"
            min="1"
            max="50"
            value="10"
            class="w-full"
          />
        </div>

        <div class="mb-5 group">
          <div class="flex justify-between mb-2">
            <label
              class="text-xs text-gray-300 font-bold uppercase tracking-wide"
              >Note Stability</label
            >
            <span
              class="text-xs font-mono text-blue-400 bg-blue-900/30 px-1.5 rounded"
              id="smoothVal"
              >4</span
            >
          </div>
          <input
            type="range"
            id="smoothSlider"
            min="1"
            max="15"
            value="4"
            class="w-full"
          />
        </div>

        <div class="mb-5 group">
          <div class="flex justify-between mb-2">
            <label
              class="text-xs text-gray-300 font-bold uppercase tracking-wide"
              >Ball Speed</label
            >
            <span
              class="text-xs font-mono text-blue-400 bg-blue-900/30 px-1.5 rounded"
              id="physVal"
              >12</span
            >
          </div>
          <input
            type="range"
            id="physSlider"
            min="5"
            max="30"
            value="12"
            class="w-full"
          />
        </div>

        <div
          class="pt-4 border-t border-gray-700 flex justify-between items-center"
        >
          <label
            class="text-xs text-gray-400 flex items-center gap-2 cursor-pointer"
          >
            <input
              type="checkbox"
              id="showStatsCheck"
              class="rounded bg-gray-700 border-gray-600 text-blue-500"
            />
            Show Nerd Stats
          </label>
          <button
            id="saveSettings"
            class="bg-blue-600 hover:bg-blue-500 px-5 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 transition-transform active:scale-95"
          >
            Done
          </button>
        </div>
      </div>
    </div>

    <!-- Game Canvas -->
    <div class="relative flex-1 w-full overflow-hidden bg-gray-900">
      <canvas id="gameCanvas"></canvas>

      <!-- Start Screen -->
      <div
        id="gameOverlay"
        class="overlay absolute inset-0 flex flex-col items-center justify-center z-30 p-6 text-center"
      >
        <h1
          class="text-5xl font-extrabold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 drop-shadow-sm"
        >
          Do Re Mi
        </h1>
        <p class="text-gray-400 mb-8 text-lg font-medium tracking-wide">
          Fixed Pitch (Do = C)
        </p>

        <div
          class="bg-gray-800/80 p-6 rounded-2xl border border-gray-700 shadow-2xl max-w-sm w-full mb-8 text-left backdrop-blur-md"
        >
          <div class="space-y-5">
            <div class="flex items-start">
              <div
                class="bg-purple-500/20 text-purple-400 p-2 rounded-lg mr-4 mt-0.5"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div>
                <p class="text-white font-bold text-sm">1. Set Range</p>
                <p class="text-gray-400 text-xs mt-0.5">
                  Click "Range" to match your voice (Low, Mid, High). Do is
                  ALWAYS C.
                </p>
              </div>
            </div>
            <div class="flex items-start">
              <div
                class="bg-green-500/20 text-green-400 p-2 rounded-lg mr-4 mt-0.5"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <div>
                <p class="text-white font-bold text-sm">2. Sing to Play</p>
                <p class="text-gray-400 text-xs mt-0.5">
                  Use your voice or a keyboard/piano.
                </p>
              </div>
            </div>
          </div>
        </div>

        <button
          id="startBtn"
          class="px-10 py-4 bg-blue-600 hover:bg-blue-500 text-white text-xl font-bold rounded-xl shadow-lg shadow-blue-600/40 transition transform active:scale-95 border-b-4 border-blue-800"
        >
          Start Game
        </button>
      </div>
    </div>

    <script>
      /* -------------------------------------------------------------------------- */
      /* STATE & CONFIG                                                             */
      /* -------------------------------------------------------------------------- */
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      let analyser, microphone, dataArray, gainNode;
      let isAudioInitialized = false;

      const noteLabels = ["Do", "Re", "Mi", "Fa", "Sol", "La", "Si", "Do"];
      const laneColors = [
        "#1f2937",
        "#111827",
        "#1f2937",
        "#111827",
        "#1f2937",
        "#111827",
        "#1f2937",
        "#111827",
      ];
      const noteColors = [
        "hsl(0, 80%, 60%)",
        "hsl(30, 80%, 60%)",
        "hsl(60, 80%, 50%)",
        "hsl(120, 70%, 50%)",
        "hsl(180, 70%, 50%)",
        "hsl(240, 70%, 60%)",
        "hsl(280, 70%, 60%)",
        "hsl(0, 80%, 60%)",
      ];

      // MIDI CONFIG: C3 = 48 (130Hz)
      // We default to C3-C4 range
      let baseMIDINote = 48; // C3
      let isTuning = false;

      let config = {
        sensitivity: 10,
        smoothingBuffer: 4,
        ballPhysicsSpeed: 12,
        gameSpeed: 200,
      };

      /* -------------------------------------------------------------------------- */
      /* UI CONTROLLERS                                                             */
      /* -------------------------------------------------------------------------- */
      const modal = document.getElementById("settingsModal");
      const sensSlider = document.getElementById("sensSlider");
      const smoothSlider = document.getElementById("smoothSlider");
      const physSlider = document.getElementById("physSlider");
      const statsCheck = document.getElementById("showStatsCheck");
      const practiceBtn = document.getElementById("practiceBtn");

      document
        .getElementById("settingsBtn")
        .addEventListener("click", () => modal.classList.remove("hidden"));
      document
        .getElementById("closeSettings")
        .addEventListener("click", () => modal.classList.add("hidden"));
      document
        .getElementById("saveSettings")
        .addEventListener("click", () => modal.classList.add("hidden"));

      sensSlider.addEventListener("input", (e) => {
        config.sensitivity = parseInt(e.target.value);
        document.getElementById("sensVal").innerText = config.sensitivity;
        const marker = document.getElementById("thresholdMarker");
        if (marker) marker.style.left = config.sensitivity + "%";
      });

      smoothSlider.addEventListener("input", (e) => {
        config.smoothingBuffer = parseInt(e.target.value);
        document.getElementById("smoothVal").innerText = config.smoothingBuffer;
      });

      physSlider.addEventListener("input", (e) => {
        config.ballPhysicsSpeed = parseInt(e.target.value);
        document.getElementById("physVal").innerText = config.ballPhysicsSpeed;
      });

      statsCheck.addEventListener("change", (e) => {
        const stats = document.getElementById("nerdStats");
        if (e.target.checked) stats.classList.remove("hidden");
        else stats.classList.add("hidden");
      });

      let practiceMode = false;
      let practiceTargetLane = -1;

      practiceBtn.addEventListener("click", () => {
        practiceMode = !practiceMode;
        const btn = document.getElementById("practiceBtn");
        const status = document.getElementById("practiceStatus");

        if (practiceMode) {
          btn.classList.replace("border-gray-600", "border-blue-500");
          status.innerText = "Practice";
          status.classList.add("text-blue-400");
          state.walls = [];
        } else {
          btn.classList.replace("border-blue-500", "border-gray-600");
          status.innerText = "Game";
          status.classList.remove("text-blue-400");
          practiceTargetLane = -1;
        }
      });

      /* -------------------------------------------------------------------------- */
      /* AUDIO SYSTEM                                                               */
      /* -------------------------------------------------------------------------- */
      async function initAudio() {
        try {
          if (audioCtx.state === "suspended") await audioCtx.resume();
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              autoGainControl: true,
              noiseSuppression: true,
            },
          });

          microphone = audioCtx.createMediaStreamSource(stream);
          gainNode = audioCtx.createGain();
          gainNode.gain.value = 4.0;

          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 2048;
          dataArray = new Float32Array(analyser.fftSize);

          microphone.connect(gainNode);
          gainNode.connect(analyser);

          isAudioInitialized = true;
          document.getElementById("debugStatus").innerText = "Active";
          return true;
        } catch (err) {
          return false;
        }
      }

      function getPitch(buf, sampleRate) {
        let SIZE = buf.length;
        let rms = 0;
        for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
        rms = Math.sqrt(rms / SIZE);

        const volPct = Math.min(100, rms * 2000);
        document.getElementById("micVolumeBar").style.width = `${volPct}%`;
        const dRMS = document.getElementById("debugRMS");
        if (dRMS) dRMS.innerText = rms.toFixed(4);

        const threshold = config.sensitivity / 1000;
        const volBar = document.getElementById("micVolumeBar");

        if (state.ignoreInput) {
          volBar.classList.replace("bg-green-500", "bg-gray-600");
          return { freq: -1, confidence: 0 };
        }

        if (rms < threshold) {
          volBar.classList.replace("bg-green-500", "bg-gray-600");
          const dStat = document.getElementById("debugStatus");
          if (dStat) dStat.innerText = "Silence";
          return { freq: -1, confidence: 0 };
        }

        volBar.classList.replace("bg-gray-600", "bg-green-500");
        const dStat = document.getElementById("debugStatus");
        if (dStat) dStat.innerText = "Listening";

        // AutoCorrelation
        const minPeriod = Math.floor(sampleRate / 1200); // Up to High C5
        const maxPeriod = Math.floor(sampleRate / 60); // Down to Low C2

        let maxCorr = 0;
        let correlations = new Array(maxPeriod).fill(0);

        for (let p = minPeriod; p <= maxPeriod; p++) {
          let sum = 0;
          for (let i = 0; i < SIZE - p && i < 1000; i++)
            sum += buf[i] * buf[i + p];
          let norm = sum / (1000 * rms * rms);
          correlations[p] = norm;
          if (norm > maxCorr) maxCorr = norm;
        }

        const dConf = document.getElementById("debugConf");
        if (dConf) dConf.innerText = maxCorr.toFixed(2);

        if (maxCorr < 0.7) {
          if (dStat) dStat.innerText = "Unclear";
          return { freq: -1, confidence: maxCorr };
        }

        let bestPeriod = -1;
        const peakThreshold = maxCorr * 0.9;
        for (let p = minPeriod; p <= maxPeriod; p++) {
          if (correlations[p] > peakThreshold) {
            bestPeriod = p;
            break;
          }
        }

        return { freq: sampleRate / bestPeriod, confidence: maxCorr };
      }

      /* -------------------------------------------------------------------------- */
      /* TUNING SYSTEM (OCTAVE SELECTOR)                                            */
      /* -------------------------------------------------------------------------- */
      const tuneBtn = document.getElementById("tuneBtn");
      tuneBtn.addEventListener("click", async () => {
        if (isTuning) return;
        if (!isAudioInitialized) {
          const success = await initAudio();
          if (!success) {
            document.getElementById("tuneStatus").innerText = "Mic Error";
            return;
          }
        }

        isTuning = true;
        tuneBtn.classList.remove("bg-gray-800");
        tuneBtn.classList.add(
          "tuning-pulse",
          "bg-yellow-600",
          "border-yellow-400"
        );
        document.getElementById("tuneStatus").innerText = "Say 'Ahhh'";

        let samples = [];
        let counter = 0;

        const interval = setInterval(() => {
          analyser.getFloatTimeDomainData(dataArray);
          let res = getPitch(dataArray, audioCtx.sampleRate);
          if (res.freq > 60 && res.confidence > 0.5) samples.push(res.freq);

          counter++;
          if (counter > 50) finishTuning(samples, interval);
        }, 50);
      });

      function finishTuning(samples, interval) {
        clearInterval(interval);
        isTuning = false;
        tuneBtn.classList.remove(
          "tuning-pulse",
          "bg-yellow-600",
          "border-yellow-400"
        );

        if (samples.length > 5) {
          samples.sort((a, b) => a - b);
          const median = samples[Math.floor(samples.length / 2)];

          // Find Nearest C Octave
          // We want median to be around middle of range (G)
          // If median ~196Hz (G3), Base should be C3 (130Hz)
          // If median ~98Hz (G2), Base should be C2 (65Hz)

          // Freq of C2=65.4, C3=130.8, C4=261.6
          // Let's check distance to these centers (G2=98, G3=196, G4=392)

          const distG2 = Math.abs(median - 98);
          const distG3 = Math.abs(median - 196);
          const distG4 = Math.abs(median - 392);

          let label = "";
          if (distG2 < distG3 && distG2 < distG4) {
            baseMIDINote = 36; // C2 (Low/Bass)
            label = "C2-C3";
          } else if (distG3 < distG4) {
            baseMIDINote = 48; // C3 (Mid/Tenor)
            label = "C3-C4";
          } else {
            baseMIDINote = 60; // C4 (High/Soprano)
            label = "C4-C5";
          }

          document.getElementById("tuneStatus").innerText = label;

          tuneBtn.classList.add("bg-green-600", "border-green-400");
          setTimeout(() => {
            tuneBtn.classList.remove("bg-green-600", "border-green-400");
            tuneBtn.classList.add("bg-gray-800");
          }, 1500);
        } else {
          document.getElementById("tuneStatus").innerText = "Fail";
          tuneBtn.classList.add("bg-red-600");
          setTimeout(() => {
            tuneBtn.classList.remove("bg-red-600");
            tuneBtn.classList.add("bg-gray-800");
            document.getElementById("tuneStatus").innerText = "Retry";
          }, 1500);
        }
      }

      /* -------------------------------------------------------------------------- */
      /* LOGIC: FREQ -> FIXED DO (C)                                                */
      /* -------------------------------------------------------------------------- */
      function freqToNoteIndex(freq) {
        if (freq === -1 || !freq) return -1;

        document.getElementById("debugHz").innerText = Math.round(freq);

        // Convert Freq to MIDI Note Number
        // MIDI 69 = A4 = 440Hz
        let midiNum = 12 * (Math.log(freq / 440) / Math.log(2)) + 69;
        let roundedMidi = Math.round(midiNum);

        document.getElementById("debugMidi").innerText = roundedMidi;

        // Calculate Offset from our Base C
        let diff = roundedMidi - baseMIDINote;

        // Check if within our 1-octave range (0 to 12)
        // 0=Do(C), 12=High Do(C)
        // Map Major Scale Intervals: 0, 2, 4, 5, 7, 9, 11, 12

        let idx = -1;
        if (diff === 0) idx = 0; // Low Do
        else if (diff === 2) idx = 1; // Re
        else if (diff === 4) idx = 2; // Mi
        else if (diff === 5) idx = 3; // Fa
        else if (diff === 7) idx = 4; // Sol
        else if (diff === 9) idx = 5; // La
        else if (diff === 11) idx = 6; // Si
        else if (diff === 12) idx = 7; // High Do

        // Out of bounds/Chromatic handling
        // If user hits C# (1), map to C (0) or D (1)?
        // Let's snap to nearest diatonic
        if (idx === -1) {
          if (diff === 1) idx = 0; // C# -> C
          else if (diff === 3) idx = 2; // D# -> E
          else if (diff === 6) idx = 3; // F# -> F
          else if (diff === 8) idx = 4; // G# -> G
          else if (diff === 10) idx = 6; // A# -> B

          // Range clamping
          if (diff < 0) idx = 0; // Too low -> C
          if (diff > 12) idx = 7; // Too high -> High C
        }

        return idx;
      }

      /* -------------------------------------------------------------------------- */
      /* GAME ENGINE                                                                */
      /* -------------------------------------------------------------------------- */
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const LANES = 8;

      let state = {
        running: false,
        score: 0,
        speed: 200,
        walls: [],
        playerY: 0,
        currentNoteIdx: 0,
        laneHeight: 0,
        lastTime: 0,
        spawnTimer: 0,
        ignoreInput: false,
        rawPlayerY: 0,
      };

      function resize() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        state.laneHeight = canvas.height / LANES;
        if (!state.running) {
          state.playerY = canvas.height / 2;
          state.rawPlayerY = state.playerY;
        }
      }
      window.addEventListener("resize", resize);
      resize();

      // Click Lane Sound
      canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const clickedLaneIndex = Math.floor(y / state.laneHeight);

        if (practiceMode) {
          if (clickedLaneIndex === practiceTargetLane) practiceTargetLane = -1;
          else practiceTargetLane = clickedLaneIndex;
          playToneForLane(clickedLaneIndex);
        } else {
          playToneForLane(clickedLaneIndex);
          flashLane(clickedLaneIndex);
        }
      });

      let activeFlash = -1;
      function flashLane(idx) {
        activeFlash = idx;
        setTimeout(() => {
          activeFlash = -1;
        }, 200);
      }

      let toneTimeout;
      function playToneForLane(laneIndex) {
        if (audioCtx.state === "suspended") audioCtx.resume();
        state.ignoreInput = true;
        if (toneTimeout) clearTimeout(toneTimeout);

        const volBar = document.getElementById("micVolumeBar");
        volBar.classList.add("bg-gray-500");
        volBar.classList.remove("bg-green-500");

        // Calculate Freq from MIDI
        const musicalIndex = LANES - 1 - laneIndex;
        const semitonesMap = [0, 2, 4, 5, 7, 9, 11, 12];
        const targetMIDI = baseMIDINote + semitonesMap[musicalIndex];
        const freq = 440 * Math.pow(2, (targetMIDI - 69) / 12);

        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = freq;

        g.gain.setValueAtTime(0, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.05);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);

        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.6);

        toneTimeout = setTimeout(() => {
          state.ignoreInput = false;
          volBar.classList.remove("bg-gray-500");
          volBar.classList.add("bg-green-500");
        }, 600);
      }

      class Wall {
        constructor() {
          this.x = canvas.width;
          this.w = 80;
          this.holeIdx = Math.floor(Math.random() * LANES);
          this.passed = false;
        }
        update(dt) {
          this.x -= state.speed * dt;
        }
        draw(ctx) {
          let lh = state.laneHeight;
          let visualRow = LANES - 1 - this.holeIdx;
          let holeY = visualRow * lh;

          ctx.fillStyle = "#92400e";
          if (visualRow > 0) {
            ctx.fillRect(this.x, 0, this.w, holeY);
            ctx.strokeStyle = "rgba(0,0,0,0.2)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(this.x + 20, 0);
            ctx.lineTo(this.x + 20, holeY);
            ctx.stroke();
          }
          let bottomY = holeY + lh;
          if (bottomY < canvas.height) {
            ctx.fillRect(this.x, bottomY, this.w, canvas.height - bottomY);
            ctx.beginPath();
            ctx.moveTo(this.x + 20, bottomY);
            ctx.lineTo(this.x + 20, canvas.height);
            ctx.stroke();
          }
          ctx.strokeStyle = "#facc15";
          ctx.lineWidth = 4;
          ctx.strokeRect(this.x, holeY, this.w, lh);
          ctx.fillStyle = "#fff";
          ctx.font = "bold 28px Fredoka";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(
            noteLabels[this.holeIdx],
            this.x + this.w / 2,
            holeY + lh / 2
          );
        }
      }

      let noteBuffer = [];
      let stableNote = 3;
      let stabilityCounter = 0;

      function update(dt) {
        if (!isAudioInitialized) return;

        if (!state.ignoreInput) {
          analyser.getFloatTimeDomainData(dataArray);
          let result = getPitch(dataArray, audioCtx.sampleRate);

          if (document.getElementById("hzDisplay"))
            document.getElementById("hzDisplay").innerText = Math.round(
              result.freq > 0 ? result.freq : 0
            );

          let newDetectedNote = -1;

          if (result.freq > 0) {
            let idx = freqToNoteIndex(result.freq);
            if (idx !== -1) {
              newDetectedNote = idx;
              let rawVisualRow = LANES - 1 - idx;
              let rawTargetPx =
                rawVisualRow * state.laneHeight + state.laneHeight / 2;
              state.rawPlayerY += (rawTargetPx - state.rawPlayerY) * 15 * dt;
            }
          }

          if (newDetectedNote !== -1) {
            if (newDetectedNote === stableNote) {
              stabilityCounter++;
            } else {
              stabilityCounter = 0;
              stableNote = newDetectedNote;
            }
            if (stabilityCounter >= config.smoothingBuffer) {
              state.currentNoteIdx = stableNote;
              const noteEl = document.getElementById("noteDisplay");
              noteEl.innerText = noteLabels[state.currentNoteIdx];
              noteEl.style.color = noteColors[state.currentNoteIdx];
            }
          }
        }

        let visualRow = LANES - 1 - state.currentNoteIdx;
        let targetPx = visualRow * state.laneHeight + state.laneHeight / 2;
        let speedFactor = config.ballPhysicsSpeed;
        state.playerY += (targetPx - state.playerY) * speedFactor * dt;

        if (!practiceMode) {
          state.spawnTimer += dt;
          if (state.spawnTimer > 3.5) {
            state.walls.push(new Wall());
            state.spawnTimer = 0;
            state.speed = config.gameSpeed + state.score * 5;
          }

          state.walls.forEach((w, i) => {
            w.update(dt);
            if (w.x + w.w < 0) state.walls.splice(i, 1);
            let px = 80;
            let pr = 12;
            if (px + pr > w.x && px - pr < w.x + w.w) {
              let visualRow = LANES - 1 - w.holeIdx;
              let holeTop = visualRow * state.laneHeight;
              let holeBot = holeTop + state.laneHeight;
              let pad = 8;
              if (
                state.playerY - pr + pad < holeTop ||
                state.playerY + pr - pad > holeBot
              )
                gameOver();
            }
            if (!w.passed && px > w.x + w.w) {
              w.passed = true;
              state.score++;
              document.getElementById("scoreDisplay").innerText = state.score;
            }
          });
        } else {
          state.walls = [];
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < LANES; i++) {
          let y = i * state.laneHeight;
          if (i === activeFlash || i === practiceTargetLane) {
            ctx.fillStyle = "#374151";
          } else {
            ctx.fillStyle = laneColors[i];
          }
          ctx.fillRect(0, y, canvas.width, state.laneHeight);

          let musicalIdx = LANES - 1 - i;
          ctx.fillStyle = noteColors[musicalIdx];
          ctx.font = "bold 30px Fredoka";
          ctx.textAlign = "left";
          ctx.textBaseline = "middle";
          ctx.fillText(noteLabels[musicalIdx], 20, y + state.laneHeight / 2);

          // Helper Hertz Display next to Note
          // Calculate Hz for this lane based on baseMIDINote
          const semitonesMap = [0, 2, 4, 5, 7, 9, 11, 12];
          const targetMIDI = baseMIDINote + semitonesMap[musicalIdx];
          const freq = Math.round(440 * Math.pow(2, (targetMIDI - 69) / 12));
          ctx.fillStyle = "rgba(255,255,255,0.1)";
          ctx.font = "10px monospace";
          ctx.fillText(`${freq}Hz`, 65, y + state.laneHeight / 2 + 12);

          ctx.fillStyle = "rgba(255,255,255,0.2)";
          ctx.font = "12px Fredoka";
          ctx.fillText("â–¶", 65, y + state.laneHeight / 2 - 5);

          if (practiceMode && i === practiceTargetLane) {
            ctx.strokeStyle = "#60a5fa";
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(80, y + state.laneHeight / 2);
            ctx.lineTo(canvas.width, y + state.laneHeight / 2);
            ctx.stroke();
            ctx.setLineDash([]);
          }

          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.strokeStyle = "rgba(255,255,255,0.05)";
          ctx.stroke();
        }

        state.walls.forEach((w) => w.draw(ctx));

        ctx.beginPath();
        ctx.arc(80, state.rawPlayerY, 15, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
        ctx.fill();

        ctx.beginPath();
        ctx.arc(80, state.playerY, 15, 0, Math.PI * 2);
        let noteColor = noteColors[state.currentNoteIdx];
        ctx.fillStyle = noteColor;
        ctx.shadowBlur = 20;
        ctx.shadowColor = noteColor;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.fillStyle = "#fff";
        ctx.font = "bold 14px Fredoka";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(noteLabels[state.currentNoteIdx], 80, state.playerY);
      }

      function loop(ts) {
        if (!state.running) return;
        let dt = (ts - state.lastTime) / 1000;
        if (dt > 0.1) dt = 0.1;
        state.lastTime = ts;
        update(dt);
        draw();
        requestAnimationFrame(loop);
      }

      function start() {
        initAudio().then((ok) => {
          if (ok) {
            document.getElementById("gameOverlay").classList.add("hidden");
            state.score = 0;
            state.walls = [];
            state.speed = config.gameSpeed;
            state.running = true;
            state.lastTime = performance.now();
            document.getElementById("scoreDisplay").innerText = "0";
            state.currentNoteIdx = 3;
            state.playerY = canvas.height / 2;
            state.playerVel = 0;
            requestAnimationFrame(loop);
          }
        });
      }

      function gameOver() {
        state.running = false;
        const ol = document.getElementById("gameOverlay");
        ol.classList.remove("hidden");
        ol.querySelector("h1").innerText = "Hit!";
        document.getElementById("startBtn").innerText = "Retry";
      }

      document.getElementById("startBtn").addEventListener("click", start);
    </script>
  </body>
</html>
